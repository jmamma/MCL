/* Copyright 2018, Justin Mammarella jmamma@gmail.com */

#ifndef MDEXPLOIT_H__
#define MDEXPLOIT_H__

#include "MD.h"
#include "MidiClock.h"
#include "midi-common.hh"

#define EXPLOIT_MAX_NOTES 20
#define EXPLOIT_DELAY_TIME 200

class MDExploitMidiEvents : public MidiCallback {
public:
  bool state = false;

  void setup_callbacks();
  void remove_callbacks();

  uint8_t note_to_trig(uint8_t);
  // Callbacks for intercepting MD triggers as GUI input
  void onNoteOnCallback_Midi(uint8_t *msg);
  void onNoteOffCallback_Midi(uint8_t *msg);
  // Control change callback required to disable exploit if CC received
  // Any updating of MD display causes exploit to fail.
  void onControlChangeCallback_Midi(uint8_t *msg);
};

class MDExploitCallbacks : public ClockCallback {
public:
  bool state;
  void onMidiStartCallback();

  void onMidiStopCallback();
  void setup_callbacks();
  void remove_callbacks();
};

extern uint8_t last_md_track;

class MDExploit {
public:

  // Flag to indicate global initalisation
  bool globals_initialized;
  // State to indicate whether exploit is on or off
  bool state;

  uint8_t track_with_nolocks;
  bool rec_global;
  // Clock when export started for timeout
  uint16_t start_clock = 0;
  MDExploitCallbacks md_exploit_callbacks;
  MDExploitMidiEvents md_exploit_midievents;
  bool ignore_last_track_once = false;

  MDExploit() {}
  void setup();
  void setup_global(uint8_t global_num);
  void send_globals();
  void switch_global(uint8_t global_page);
  bool on(bool switch_tracks = true);
  bool off(bool switch_tracks = true);
};

extern MDExploit md_exploit;

#endif /* MDEXPLOIT_H__ */
